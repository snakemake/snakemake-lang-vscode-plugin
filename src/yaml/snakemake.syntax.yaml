---
name: Snakemake
scopeName: source.python.snakemake
fileTypes: [Snakefile, smk]

patterns:
  - include: "#snakestrings"
  - include: "#configs"
  - include: "#rules"
  - include: "#modules"
  - include: "#useruleas"
  - include: "#userulefromas"
  - include: "#ruleparams"
  - include: "#rulerunparams"
  - include: "#moduleparams"
  - include: source.python

repository:
  configs:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{configs}}) # Keywords
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake.config }

  rules:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{rules}}) # Keywords
        (?:\s+({{legal-name}}))? # Optional rule name
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake }
      "2": { name: entity.name.function.snakemake.rule }

  modules:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{modules}}) # Keywords
        (?:\s+({{legal-name}}))? # Optional rule name
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake }
      "2": { name: entity.name.type.snakemake.rule }

  useruleas:
    match: >
      (?x)
        ^\s* # Leading whitespace
        (use\s+rule) \s+ ({{legal-name}})
        \s+ (as) \s+ ({{legal-name}})
        \s+ (with)
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake }
      "2": { name: entity.name.function.snakemake.rule }
      "3": { name: keyword.control.snakemake }
      "4": { name: entity.name.function.snakemake.rule }
      "5": { name: keyword.control.snakemake }
  userulefromas:
    match: >
      (?x)
        ^\s* # Leading whitespace
        (use\s+rule) \s+ (\w+|\w+\*|\*)
        \s+ (from) \s+ ({{legal-name}})
        (?:\s+
          (as) \s+ (\w+|\w+\*)
        )?
        (?:\s+
          (exclude) \s+
          ({{legal-name}})
          (?:\s*
            , \s* ({{legal-name}})
          )*
        )?
        # may end with a "with:", but that can be caught by other regexes
    captures:
      "1": { name: keyword.control.snakemake }
      "2": { name: entity.name.function.snakemake.rule }
      "3": { name: keyword.control.snakemake }
      "4": { name: entity.name.type.snakemake.rule }
      "5": { name: keyword.control.snakemake }
      "6": { name: entity.name.function.snakemake.rule }
      "7": { name: keyword.control.snakemake }
      "8": { name: entity.name.function.snakemake.rule }
      "9": { name: entity.name.function.snakemake.rule }

  ruleparams:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{ruleparams}}) # Keywords
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake.ruleparam }
  rulerunparams:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{rulerunparams}}) # Keywords
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake.rulerunparam }
  moduleparams:
    match: >
      (?x)
        ^\s* # Leading whitespace
        ({{moduleparams}}) # Keywords
        : # Ending in colon
    captures:
      "1": { name: keyword.control.snakemake.moduleparam }

  snakestrings:
    name: string.quoted.docstring.snakemake
    begin: \s+(\'\'\'|\"\"\"|\'|\")
    end: (\1)
    beginCaptures:
      "1": { name: punctuation.definition.string.begin.python }
    endCaptures:
      "1": { name: punctuation.definition.string.end.python }
    patterns:
      - include: "source.python#string-single-bad-brace1-formatting-unicode"
      - include: "source.python#string-single-bad-brace2-formatting-unicode"
      - include: "source.python#string-unicode-guts"
